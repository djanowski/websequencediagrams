#! /usr/bin/env ruby
require 'net/http'
require 'uri'

if $stdout.tty?
  if File.exist?(ARGV[0])
    text = File.read(ARGV[0])
  else
    require 'open-uri'
    text = open(ARGV[0], 'Accept' => 'text/plain').read
  end
else
  text = readlines.join
end

format = ARGV[2] || "png"
supported_formats = %w{ pdf png jpg svg}
if not supported_formats.member? format
	raise "Format not supported"
end

file = "#{ ARGV[1]}.#{ format }"

response = Net::HTTP.post_form(URI.parse('http://www.websequencediagrams.com/index.php'), {'style' => 'napkin', 'message' => text, 'format' => format})

if %w{png jpg svg}.member? format
  if response.body =~ /img: "(.+)"/
    system("open http://www.websequencediagrams.com/#{$1}")
  end
elsif response.body =~ /img: "(.+)"/
  puts "Writing to file #{file}"
  request_file = "http://www.websequencediagrams.com/#{$1}"
  puts "Reading from uri #{request_file}"
  response_file = Net::HTTP.get(URI.parse(request_file))
  File.open(file, "w+") { |f| f << response_file }
end